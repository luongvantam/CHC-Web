<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dịch ROP</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header>
        <h1>Casio Hacking Community</h1>
        <span class="menu-toggle">☰ Menu</span>
    </header>
    <main>
        <nav class="menu">
            <ul>
                <li><a href="index.html">Trang Chủ</a></li>
                <li><a href="documents.html">Tài Liệu</a></li>
                <li><a href="tools.html">Công Cụ Hỗ trợ</a></li>
            </ul>
        </nav>
        <div class="overlay"></div>
        <div class="content">
            <h2>Dịch ROP</h2>
            <div>
                <label>Chọn Model Dịch Từ</label>
                <select id="modelFrom" onchange="checkTranslationPair()">
                    <option value="fx991cnx.txt">fx991cnx</option>
                    <option value="fx580vnx.txt">fx580vnx</option>
                    <option value="fx880btg.txt">fx880btg</option>
                    <option value="fx991cncw.txt">fx991cncw</option>
                </select>
            </div>
            <div>
                <label>Chọn Model Dịch Đến</label>
                <select id="modelTo" onchange="checkTranslationPair()">
                    <option value="fx580vnx.txt">fx580vnx</option>
                    <option value="fx991cnx.txt">fx991cnx</option>
                    <option value="fx880btg.txt">fx880btg</option>
                    <option value="fx991cncw.txt">fx991cncw</option>
                </select>
            </div>
            <div>
                <p id="fileStatus">Đang tải file, vui lòng đợi...</p>
                <p id="pairError" style="color: red; display: none;">Lỗi: Chỉ hỗ trợ fx880btg ↔ fx991cncw và fx580vnx ↔ fx991cnx.</p>
            </div>
            <div>
                <label>Nhập:</label>
                <textarea id="gadgetInput" rows="5" placeholder="Ví dụ: 2:03D2H"></textarea>
            </div>
            <button id="translateBtn" disabled>Dịch</button>
            <h2>Kết Quả:</h2>
            <div class="text-box" style="text-align: left; height: 300px;">
                <pre id="outputText"></pre>
            </div>
        </div>
        <script>
            let fileData = {};
            const statusMessage = document.getElementById("fileStatus");
            const pairErrorMessage = document.getElementById("pairError");
            const translateButton = document.getElementById("translateBtn");

            function checkTranslationPair() {
                const sourceModel = document.getElementById("modelFrom").value;
                const targetModel = document.getElementById("modelTo").value;

                const validPairs = [
                    ["fx880btg.txt", "fx991cncw.txt"],
                    ["fx991cncw.txt", "fx880btg.txt"],
                    ["fx991cncw.txt", "fx991cncw.txt"],
                    ["fx880btg.txt", "fx880btg.txt"],
                    ["fx580vnx.txt", "fx991cnx.txt"],
                    ["fx580vnx.txt", "fx580vnx.txt"],
                    ["fx991cnx.txt", "fx991cnx.txt"],
                    ["fx991cnx.txt", "fx580vnx.txt"]
                ];

                const isValidPair = validPairs.some(pair => 
                    pair[0] === sourceModel && pair[1] === targetModel
                );

                if (!isValidPair) {
                    pairErrorMessage.style.display = "block";
                    translateButton.disabled = true;
                } else {
                    pairErrorMessage.style.display = "none";
                    if (fileData[sourceModel] && fileData[targetModel]) {
                        translateButton.disabled = false;
                    }
                }
            }

            async function loadFiles() {
                statusMessage.classList.remove("hidden");
                statusMessage.textContent = "Đang tải file, chờ chút nhé...";

                try {
                    const [data991, data580, data880, data991cw] = await Promise.all([
                        fetch("data/fx991cnx.txt").then(res => res.text()),
                        fetch("data/fx580vnx.txt").then(res => res.text()),
                        fetch("data/fx880btg.txt").then(res => res.text()),
                        fetch("data/fx991cncw.txt").then(res => res.text())
                    ]);

                    fileData["fx991cnx.txt"] = data991.split("\n").filter(line => line.trim());
                    fileData["fx580vnx.txt"] = data580.split("\n").filter(line => line.trim());
                    fileData["fx880btg.txt"] = data880.split("\n").filter(line => line.trim());
                    fileData["fx991cncw.txt"] = data991cw.split("\n").filter(line => line.trim());

                    console.log("Dữ liệu fx991cnx.txt:", fileData["fx991cnx.txt"].slice(0, 5));
                    console.log("Dữ liệu fx580vnx.txt:", fileData["fx580vnx.txt"].slice(0, 5));
                    console.log("Dữ liệu fx880btg.txt:", fileData["fx880btg.txt"].slice(0, 5));
                    console.log("Dữ liệu fx991cncw.txt:", fileData["fx991cncw.txt"].slice(0, 5));

                    if (fileData["fx991cnx.txt"].length && fileData["fx580vnx.txt"].length && 
                        fileData["fx880btg.txt"].length && fileData["fx991cncw.txt"].length) {
                        statusMessage.classList.add("hidden");
                        checkTranslationPair();
                    } 
                } catch (error) {
                    statusMessage.textContent = "Lỗi tải file!";
                    console.error("Lỗi tải file:", error);
                }
            }

            window.onload = loadFiles;

            function translateMain(targetModel, sourceModel, searchString) {
                let sourceIndex = -1;
                let targetIndex;

                for (let sourceLine of sourceModel) {
                    sourceIndex++;
                    if (sourceLine.toLowerCase().includes(searchString.toLowerCase())) {
                        targetIndex = -1;
                        for (let targetLine of targetModel) {
                            targetIndex++;
                            try {
                                const sourcePart = sourceModel[sourceIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                const targetPart = targetModel[targetIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                if (sourcePart === targetPart &&
                                    sourceModel[sourceIndex-1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex-1]?.split(/\s+/)[1]?.slice(0, 4) &&
                                    sourceModel[sourceIndex+1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+1]?.split(/\s+/)[1]?.slice(0, 4) &&
                                    sourceModel[sourceIndex-2]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex-2]?.split(/\s+/)[1]?.slice(0, 4) &&
                                    sourceModel[sourceIndex+2]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+2]?.split(/\s+/)[1]?.slice(0, 4)) {
                                    return targetModel[targetIndex].slice(0, 7);
                                }
                            } catch (error) {
                                console.log(`Lỗi so sánh tại dòng ${sourceIndex}:`, error, sourceLine);
                            }
                        }
                    }
                }
                return translateLessStrict(targetModel, sourceModel, searchString);
            }

            function translateLessStrict(targetModel, sourceModel, searchString) {
                let sourceIndex = -1;
                let targetIndex;

                for (let sourceLine of sourceModel) {
                    sourceIndex++;
                    if (sourceLine.toLowerCase().includes(searchString.toLowerCase())) {
                        targetIndex = -1;
                        for (let targetLine of targetModel) {
                            targetIndex++;
                            try {
                                const sourcePart = sourceModel[sourceIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                const targetPart = targetModel[targetIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                if (sourcePart === targetPart &&
                                    sourceModel[sourceIndex-1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex-1]?.split(/\s+/)[1]?.slice(0, 4) &&
                                    sourceModel[sourceIndex+1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+1]?.split(/\s+/)[1]?.slice(0, 4)) {
                                    return targetModel[targetIndex].slice(0, 7);
                                }
                            } catch (error) {
                                console.log(`Lỗi so sánh tại dòng ${sourceIndex}:`, error, sourceLine);
                            }
                        }
                    }
                }
                return translateEvenLessStrict(targetModel, sourceModel, searchString);
            }

            function translateEvenLessStrict(targetModel, sourceModel, searchString) {
                let sourceIndex = -1;
                let targetIndex;

                for (let sourceLine of sourceModel) {
                    sourceIndex++;
                    if (sourceLine.toLowerCase().includes(searchString.toLowerCase())) {
                        targetIndex = -1;
                        for (let targetLine of targetModel) {
                            targetIndex++;
                            try {
                                const sourcePart = sourceModel[sourceIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                const targetPart = targetModel[targetIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                if (sourcePart === targetPart &&
                                    sourceModel[sourceIndex+1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+1]?.split(/\s+/)[1]?.slice(0, 4) &&
                                    sourceModel[sourceIndex+2]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+2]?.split(/\s+/)[1]?.slice(0, 4)) {
                                    return targetModel[targetIndex].slice(0, 7);
                                }
                            } catch (error) {
                                console.log(`Lỗi so sánh tại dòng ${sourceIndex}:`, error, sourceLine);
                            }
                        }
                    }
                }
                return translateMinimal(targetModel, sourceModel, searchString);
            }

            function translateMinimal(targetModel, sourceModel, searchString) {
                let sourceIndex = -1;
                let targetIndex;

                for (let sourceLine of sourceModel) {
                    sourceIndex++;
                    if (sourceLine.toLowerCase().includes(searchString.toLowerCase())) {
                        targetIndex = -1;
                        for (let targetLine of targetModel) {
                            targetIndex++;
                            try {
                                const sourcePart = sourceModel[sourceIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                const targetPart = targetModel[targetIndex].split(/\s+/)[1]?.slice(0, 4).toLowerCase() || "";
                                if (sourcePart === targetPart &&
                                    sourceModel[sourceIndex+1]?.split(/\s+/)[1]?.slice(0, 4) === targetModel[targetIndex+1]?.split(/\s+/)[1]?.slice(0, 4)) {
                                    return targetModel[targetIndex].slice(0, 7);
                                }
                            } catch (error) {
                                console.log(`Lỗi so sánh tại dòng ${sourceIndex}:`, error, sourceLine);
                            }
                        }
                    }
                }
                return `Không tìm thấy bản dịch cho: ${searchString}`;
            }

            function translateLine(targetModel, sourceModel, inputLine) {
                if (!inputLine || inputLine.trim() === "") return "";
                if (inputLine.includes("#")) return inputLine;
                
                if (inputLine.includes(":")) {
                    return translateMain(targetModel, sourceModel, inputLine);
                }

                const parts = inputLine.split(/\s+/);
                if (parts.length < 3) return `Dòng không đúng định dạng: ${inputLine}`;

                const [part1, part2, part3] = parts;
                const secondChar = part3[1] || "";
                const formattedLine = `${secondChar}:${part2}${part1}`;
                
                const result = translateMain(targetModel, sourceModel, formattedLine);
                if (result.includes("l")) return result;

                const output = `${result.slice(4, 6)} ${result.slice(2, 4)} 3${result[0] || ""} 30`;
                return output;
            }

            translateButton.addEventListener("click", () => {
                const sourceModel = document.getElementById("modelFrom").value;
                const targetModel = document.getElementById("modelTo").value;
                const inputLines = document.getElementById("gadgetInput").value.split("\n").filter(line => line.trim());
                const results = [];

                if (!fileData[sourceModel] || !fileData[targetModel]) {
                    document.getElementById("outputText").textContent = "Lỗi: File chưa tải xong!";
                    document.getElementById("output").classList.remove("hidden");
                    return;
                }

                for (let line of inputLines) {
                    if (line === "end") break;
                    const translated = translateLine(fileData[targetModel], fileData[sourceModel], line);
                    if (translated) results.push(translated);
                    console.log(`Dòng gốc: ${line}, Kết quả: ${translated}`);
                }

                const outputDiv = document.getElementById("output");
                const outputText = document.getElementById("outputText");
                outputText.textContent = results.join("\n") || "Không có gì để dịch.";
                outputDiv.classList.remove("hidden");
            });
        </script>
    </main>
    <script src="assets/js/script.js"></script>
</body>
</html>